version: "3.9"
services:
   api:
    build: 
        context: .
        dockerfile: src/Web/Harmony.Api/Dockerfile
        args:
          BUILD_CONFIGURATION: Debug
    container_name: harmony.api
    ports:
        - "7097:443"
    restart: always
    environment:
        - ASPNETCORE_ENVIRONMENT=Development
        - ASPNETCORE_URLS=https://+:443;http://+:80
        - ASPNETCORE_HTTPS_PORT=7097
        - ASPNETCORE_Kestrel__Certificates__Default__Password=HarmonyTeamsSecretKey 
        - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/harmony.pfx 
        - ConnectionStrings__HarmonyConnection=Server=harmony_sql_server;database=harmony;User Id=sa;Password=%HarmonyTeams100;TrustServerCertificate=True
        - AppEndpointConfiguration__AutomationEndpoint=https://harmony.automations:443/
        - BrokerConfiguration__Host=harmony_rabbitmq
    volumes:
        - $USERPROFILE/.aspnet/https:/https/
    depends_on:
        - sql_server
   automations:
    build: 
        context: .
        dockerfile: src/Web/Harmony.Automations/Dockerfile
        args:
          BUILD_CONFIGURATION: Debug
    container_name: harmony.automations
    ports:
        - "7277:443"
    restart: always
    environment:
        - ASPNETCORE_ENVIRONMENT=Development
        - ASPNETCORE_URLS=https://+:443;http://+:80
        - ASPNETCORE_HTTPS_PORT=7277
        - ASPNETCORE_Kestrel__Certificates__Default__Password=HarmonyTeamsSecretKey 
        - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/harmony.pfx
        - AppEndpointConfiguration__HarmonyApiEndpoint=https://harmony.api:443/
        - BrokerConfiguration__Host=harmony_rabbitmq 
        - ConnectionStrings__HarmonyJobsConnection=Server=harmony_sql_server;database=Harmony.Automations.Jobs;User Id=sa;Password=%HarmonyTeams100;TrustServerCertificate=True
        - MongoDB__ConnectionURI=mongodb://harmony_mongodb_server:27017
    volumes:
        - $USERPROFILE/.aspnet/https:/https/
    depends_on:
        - sql_server
        - rabbitmq
        - mongodb
   notifications:
    build: 
        context: .
        dockerfile: src/Web/Harmony.Notifications/Dockerfile
        args:
          BUILD_CONFIGURATION: Debug
    container_name: harmony.notifications
    ports:
        - "7121:443"
    restart: always
    environment:
        - ASPNETCORE_ENVIRONMENT=Development
        - ASPNETCORE_URLS=https://+:443;http://+:80
        - ASPNETCORE_HTTPS_PORT=7121
        - ASPNETCORE_Kestrel__Certificates__Default__Password=HarmonyTeamsSecretKey 
        - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/harmony.pfx
        - AppEndpointConfiguration__HarmonyApiEndpoint=https://harmony.api:443/
        - BrokerConfiguration__Host=harmony_rabbitmq 
        - ConnectionStrings__HarmonyJobsConnection=Server=harmony_sql_server;database=Harmony.Notifications.Jobs;User Id=sa;Password=%HarmonyTeams100;TrustServerCertificate=True
    volumes:
        - $USERPROFILE/.aspnet/https:/https/
    depends_on:
        - sql_server
        - rabbitmq
   signalr:
    build: 
        context: .
        dockerfile: src/Web/Harmony.SignalR/Dockerfile
        args:
          BUILD_CONFIGURATION: Debug
    container_name: harmony.signalr
    ports:
        - "7262:443"
    environment:
        - ASPNETCORE_ENVIRONMENT=Development
        - ASPNETCORE_URLS=https://+:443;http://+:80
        - ASPNETCORE_HTTPS_PORT=7262
        - BrokerConfiguration__Host=harmony_rabbitmq
        - ASPNETCORE_Kestrel__Certificates__Default__Password=HarmonyTeamsSecretKey 
        - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/harmony.pfx 
    volumes:
        - $USERPROFILE/.aspnet/https:/https/
    depends_on:
        - rabbitmq
   client:
    build: 
        context: .
        dockerfile: src/Web/Harmony.Client/Dockerfile
        args:
          BUILD_CONFIGURATION: Debug
    container_name: harmony.client
    ports:
        - "7096:80"
    environment:
        - ASPNETCORE_ENVIRONMENT=Development
        - ASPNETCORE_URLS=https://+:443;http://+:80
        - ASPNETCORE_HTTPS_PORT=7096
        - ASPNETCORE_Kestrel__Certificates__Default__Password=HarmonyTeamsSecretKey 
        - ASPNETCORE_Kestrel__Certificates__Default__Path=/https/harmony.pfx 
    volumes:
        - $USERPROFILE/.aspnet/https:/https/
    depends_on:
        - signalr
   rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: harmony_rabbitmq
    ports:
        - 5672:5672
        - 15672:15672
   sql_server:
    image: "mcr.microsoft.com/mssql/server:2022-latest"
    container_name: harmony_sql_server
    environment:
      - ACCEPT_EULA=y
      - SA_PASSWORD=%HarmonyTeams100
   mongodb:
    image: mongo:latest
    container_name: harmony_mongodb_server
